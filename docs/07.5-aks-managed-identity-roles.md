# 7.5 AKS Managed Identity Role Assignments

## Overview

After deploying the AKS cluster, the system-assigned managed identity must receive appropriate permissions to interact with Azure resources such as networking and Key Vault.
This step ensures AKS can manage load balancers, mount secrets via CSI, and perform other integrations securely.

---

## 7.5.1 Retrieve AKS Managed Identity

```bash
az aks show \
  --name marketflow-aks \
  --resource-group marketflow-rg \
  --query identity.principalId -o tsv
```

**Example output:**

```
55b5f02b-f51e-4d8d-930a-25f6a02d7033
```

Keep this **Principal ID** — it identifies your AKS cluster identity in Azure AD.

---

## 7.5.2 Assign Network Contributor Role

This role allows the AKS managed identity to configure network interfaces, load balancers, and routing tables inside the resource group that hosts your VNet and NSG.

```bash
az role assignment create \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --role "Network Contributor" \
  --scope /subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg
```

Confirm assignment:

```bash
az role assignment list \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --output table
```

---

## 7.5.3 Assign Key Vault Access Policy

The AKS managed identity must also be able to read secrets from **Azure Key Vault**, especially when using the Secrets Store CSI Driver.

### Option A — RBAC model (recommended)

```bash
az role assignment create \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --role "Key Vault Secrets User" \
  --scope /subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.KeyVault/vaults/marketflow-vault
```

### Option B — Classic Access Policy (if RBAC disabled)

```bash
az keyvault set-policy \
  --name marketflow-vault \
  --resource-group marketflow-rg \
  --object-id 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --secret-permissions get list
```

---

## 7.5.4 Enable Azure Key Vault Secrets Provider Add-on

Once the permissions are set, enable the CSI driver integration:

```bash
az aks enable-addons \
  --addons azure-keyvault-secrets-provider \
  --name marketflow-aks \
  --resource-group marketflow-rg
```

Verify the add-on:

```bash
az aks show \
  --name marketflow-aks \
  --resource-group marketflow-rg \
  --query addonProfiles.azureKeyvaultSecretsProvider
```

Expected:

```json
{
  "enabled": true,
  "config": {
    "enableSecretRotation": "false",
    "rotationPollInterval": "2m"
  }
}
```

---

## 7.5.5 Verify CSI Driver Pods

```bash
kubectl get pods -n kube-system | grep csi
```

Expected output example:

```
aks-secrets-store-csi-driver-2qb9g     3/3   Running
csi-azuredisk-node-qfqm9               3/3   Running
csi-azurefile-node-pq2pq               3/3   Running
```

---

## 7.5.6 Integration Test (Optional)

Create a test Pod to ensure secrets can be mounted from Key Vault:

```bash
kubectl apply -f kv-test.yaml
kubectl exec -it kv-test -- ls /mnt/secrets-store
kubectl exec -it kv-test -- cat /mnt/secrets-store/<secret-name>
```

If permissions and configuration are correct, the secret content from Azure Key Vault will be displayed.

---

## Summary

| Resource             | Role                            | Scope              |
| -------------------- | ------------------------------- | ------------------ |
| AKS Managed Identity | Network Contributor             | `marketflow-rg`    |
| AKS Managed Identity | Key Vault Secrets User          | `marketflow-vault` |
| Add-on               | azure-keyvault-secrets-provider | Enabled            |

