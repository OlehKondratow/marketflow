# 7.6 Post-AKS Configuration

## Ingress Controllers (Production + Development)

---

### 🧭 Overview

This section describes how to deploy and validate both **public (production)** and **internal (development)** ingress controllers in AKS, integrate them with **Let’s Encrypt** via cert-manager, and verify connectivity through Azure Load Balancer and DNS.

---

## 🚀 Step 7.6.1 — Deploy Public Ingress (Production)

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

kubectl create namespace ingress-prod

helm install ingress-prod ingress-nginx/ingress-nginx \
  --namespace ingress-prod \
  --set controller.ingressClassResource.name=nginx-prod \
  --set controller.ingressClass=nginx-prod \
  --set controller.ingressClassResource.default=false \
  --set controller.ingressClassResource.controllerValue="k8s.io/ingress-nginx-prod" \
  --set controller.ingressClassByName=true \
  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"="marketflow-rg" \
  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-dns-label-name"="marketflow-prod" \
  --set controller.service.type=LoadBalancer
```

**Expected Output:**

```text
NAME: ingress-prod
STATUS: deployed
NAMESPACE: ingress-prod
```

Check service:

```bash
kubectl get svc -n ingress-prod
```

✅ Expected:

```
ingress-prod-ingress-nginx-controller   LoadBalancer   10.0.39.118   4.175.110.82   80,443/TCP   ...
```

---

## 🧱 Step 7.6.2 — Deploy Internal Ingress (Development)

```bash
kubectl create namespace ingress-dev

helm install ingress-dev ingress-nginx/ingress-nginx \
  --namespace ingress-dev \
  --set controller.ingressClassResource.name=nginx-dev \
  --set controller.ingressClass=nginx-dev \
  --set controller.ingressClassResource.default=false \
  --set controller.ingressClassResource.controllerValue="k8s.io/ingress-nginx-dev" \
  --set controller.ingressClassByName=true \
  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-internal"="true" \
  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"="marketflow-rg" \
  --set controller.service.type=LoadBalancer
```

✅ Check internal LB:

```
kubectl get svc -n ingress-dev
```

Expected:

```
ingress-dev-ingress-nginx-controller   LoadBalancer   10.0.176.45   10.240.0.6   80,443/TCP
```

---

## 🌐 Step 7.6.3 — Deploy Example Applications (httpbin)

**Production:**

```bash
kubectl apply -f k8s/httpbin-prod.yaml
```

**Development:**

```bash
kubectl apply -f k8s/httpbin-dev.yaml
```

Check ingress:

```bash
kubectl get ingress -A
```

✅ Example:

```
marketflow-prod   httpbin-prod   nginx-prod   app0.okondratov.online   4.175.110.82   80,443
marketflow-dev    httpbin-dev    nginx-dev    app0-dev.okondratov.online   10.240.0.6   80
```

---

## 🔐 Step 7.6.4 — Verify TLS Certificate (Let’s Encrypt)

Check certificate:

```bash
kubectl get certificate -n marketflow-prod
kubectl describe certificate -n marketflow-prod
```

Extract and inspect with OpenSSL:

```bash
kubectl get secret httpbin-prod-tls -n marketflow-prod -o jsonpath='{.data.tls\.crt}' | base64 -d > tls.crt
kubectl get secret httpbin-prod-tls -n marketflow-prod -o jsonpath='{.data.tls\.key}' | base64 -d > tls.key
openssl x509 -in tls.crt -noout -subject -issuer -dates
```

✅ Expected:

```
subject=CN=app0.okondratov.online
issuer=C=US, O=Let's Encrypt, CN=R13
notBefore=Oct 27 12:56:53 2025 GMT
notAfter=Jan 25 12:56:52 2026 GMT
```

---

## 🌍 Step 7.6.5 — Add DNS Record

Create A record for your public ingress:

```
app0.okondratov.online → 4.175.110.82
```

Verify DNS:

```bash
dig +short app0.okondratov.online
nslookup app0.okondratov.online
```

✅ Expected:

```
4.175.110.82
```

---

## 🧠 Step 7.6.6 — Fix Azure Load Balancer Health Probe (if external traffic hangs)

### Add health probe annotation:

```bash
kubectl -n ingress-prod patch svc ingress-prod-ingress-nginx-controller \
  -p '{"metadata":{"annotations":{"service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path":"/healthz"}}}'
```

### Ensure traffic policy:

```bash
kubectl -n ingress-prod patch svc ingress-prod-ingress-nginx-controller \
  -p '{"spec":{"externalTrafficPolicy":"Cluster"}}'
```

### Verify probe and backends:

```bash
az network lb probe list -g MC_marketflow-rg_marketflow-aks_westeurope --lb-name kubernetes -o table
az network lb show -g MC_marketflow-rg_marketflow-aks_westeurope -n kubernetes --query "backendAddressPools[].backendIPConfigurations[].ipAddress"
```

✅ Expected:

```
[
  "10.240.0.4",
  "10.240.0.5"
]
```

---

## 🧩 Step 7.6.7 — Final Verification

### Test HTTPS from cluster:

```bash
kubectl port-forward -n ingress-prod svc/ingress-prod-ingress-nginx-controller 8443:443
curl -vk -H "Host: app0.okondratov.online" https://localhost:8443/get --insecure
```

### Test HTTPS externally:

```bash
curl -vk https://app0.okondratov.online/get
```

✅ Expected:

```
HTTP/2 200
{
  "url": "https://app0.okondratov.online/get"
}
```

---

## ✅ Summary Checklist

| Check                                  | Status |
| -------------------------------------- | ------ |
| Ingress Controller (prod/dev) deployed | ✅      |
| Public IP (prod) assigned              | ✅      |
| NSG rules for 80/443                   | ✅      |
| Cert-manager issued valid TLS cert     | ✅      |
| DNS A record resolves                  | ✅      |
| Health probe active (`/healthz`)       | ✅      |
| HTTPS returns 200 OK                   | ✅      |

